!function(){"use strict";function t(t,e){var n=e.geometry.coordinates;"Polygon"===e.geometry.type&&(n=[n]);for(var i=!1,r=0;r<n.length&&!i;){if(a(t,n[r][0])){for(var o=!1,s=1;s<n[r].length&&!o;)a(t,n[r][s])&&(o=!0),s++;o||(i=!0)}r++}return i}function a(t,a){for(var e=!1,n=0,i=a.length-1;n<a.length;i=n++){var r=a[n][0],o=a[n][1],s=a[i][0],l=a[i][1],c=o>t[1]!=l>t[1]&&t[0]<(s-r)*(t[1]-o)/(l-o)+r;c&&(e=!e)}return e}function e(t,a){var e=a;return t[0][0]<a[0][0]&&(e[0][0]=t[0][0]),t[0][1]<a[0][1]&&(e[0][1]=t[0][1]),t[1][0]>a[1][0]&&(e[1][0]=t[1][0]),t[1][1]>a[1][1]&&(e[1][1]=t[1][1]),e}function n(t,a){t.lookupTree=v(4);var e=[];for(var n in t.features.features){var i=a.bounds(t.features.features[n]);e.push([i[0][0].toFixed(0),i[0][1].toFixed(0),Math.ceil(i[1][0]),Math.ceil(i[1][1]),t.features.features[n]])}t.lookupTree.load(e)}function i(t,a,e){e.context.beginPath(),e.path(a),t["static"].paintfeature(e,a)}function r(t,a){if(t["static"]){if(t["static"].prepaint&&t["static"].prepaint(a),t["static"].paintfeature){var e=t.lookupTree.search([a.translate[0],a.translate[1],a.width/a.scale-a.translate[0],a.height/a.scale-a.translate[1]]);for(var n in e)i(t,e[n][4],a)}t["static"].postpaint&&t["static"].postpaint(a)}}function o(t,a){var e=0,n=0,r=null,o=[];this.hasNext=function(){return e<=t.length&&n<o.length},this.renderNext=function(){if(!(e>=t.length&&n>=o.length)){var s=performance.now();if(!r||n>=o.length){for(;e<t.length&&!t[e]["static"];)e++;if(e>=t.length)return;r=t[e],r["static"].prepaint&&r["static"].prepaint(a),o=r.lookupTree.search([-a.translate[0],-a.translate[1],a.width/a.scale-a.translate[0],a.height/a.scale-a.translate[1]]),n=0,++e}if(r["static"].paintfeature)for(;n!=o.length;++n){var l=o[n][4];if(i(r,l,a),performance.now()-s>10)break}else n=o.length;n==o.length&&r["static"].postpaint&&r["static"].postpaint(a)}},this.finish=function(){if(!(e>=t.length&&n>=o.length))for(n<o.length&&e--;e!=t.length;++e){if(n>=o.length){for(;!t[e]["static"]&&e<t.length;)e++;if(e>=t.length)return;r=t[e],r["static"].prepaint&&r["static"].prepaint(a),o=r.lookupTree.search([-a.translate[0],-a.translate[1],a.width/a.scale-a.translate[0],a.height/a.scale-a.translate[1]]),n=0}if(r["static"].paintfeature)for(;n!=o.length;++n){var s=o[n][4];i(r,s,a)}r["static"].postpaint&&r["static"].postpaint(a)}}}function s(t,a,e){return[t[0]/a-e[0],t[1]/a-e[1]]}function l(t,a){var e={};for(var n in a)e[n]=a[n];for(var n in t)e.hasOwnProperty(n)||(e[n]=t[n]);return e}function c(a){function i(){v=p.select(u.element).append("canvas"),f=v.node().getContext("2d");var t=window.devicePixelRatio||1,a=f.webkitBackingStorePixelRatio||f.mozBackingStorePixelRatio||f.msBackingStorePixelRatio||f.oBackingStorePixelRatio||f.backingStorePixelRatio||1;u.ratio=t/a,u.area=1/u.projection.scale()/u.ratio/20,v.attr("width",u.width*u.ratio),v.attr("height",u.height*u.ratio),v.style("width",u.width+"px"),v.style("height",u.height+"px"),f.lineJoin="round",f.lineCap="round",k.context(f),f.clearRect(0,0,u.width*u.ratio,u.height*u.ratio),f.save(),f.scale(u.ratio,u.ratio);for(var e in u.data)n(u.data[e],k);u.background=new Image,u.backgroundScale=u.scale,u.backgroundTranslate=u.translate;var i={path:k,context:f,scale:u.scale,translate:u.translate,width:u.width,height:u.height,map:u.map},o=function(){var t=!1,a=!1;for(var e in u.data){var n=u.data[e];t=t||n.events&&n.events.hover,a=a||n.events&&n.events.click,n.dynamic&&n.dynamic.postpaint&&n.dynamic.postpaint(i,null)}f.restore(),a&&v.on("click",c),t&&v.on("mousemove",d).on("mouseleave",h)};for(var e in u.data){var s=u.data[e];s.dynamic&&s.dynamic.prepaint&&s.dynamic.prepaint(i,s.hoverElement)}for(var e in u.data){var s=u.data[e];r(s,i)}u.background.onload=o,u.background.src=v.node().toDataURL(),this.init=function(){}}function o(){f.save(),f.scale(u.scale*u.ratio,u.scale*u.ratio),f.translate(u.translate[0],u.translate[1]),f.clearRect(-u.translate[0],-u.translate[1],u.width*u.ratio,u.height*u.ratio),f.rect(-u.translate[0],-u.translate[1],u.width/u.scale,u.height/u.scale),f.clip();var t={path:k,context:k.context(),scale:u.scale,translate:u.translate,width:u.width,height:u.height,map:u.map};u.area=1/u.projection.scale()/u.scale/u.ratio/20;for(var a in u.data){var e=u.data[a];e.dynamic&&e.dynamic.prepaint&&e.dynamic.prepaint(t,e.hoverElement)}f.drawImage(u.background,0,0,u.width*u.ratio,u.height*u.ratio,-u.backgroundTranslate[0],-u.backgroundTranslate[1],u.width/u.backgroundScale,u.height/u.backgroundScale);for(var a in u.data){var e=u.data[a];e.dynamic&&e.dynamic.postpaint&&e.dynamic.postpaint(t,e.hoverElement)}f.restore()}function c(){var a=s(p.mouse(this),u.scale,u.translate),e={scale:u.scale,translate:u.translate,width:u.width,height:u.height,map:u.map};for(var n in u.data){var i=u.data[n];if(i.events&&i.events.click){var r=i.lookupTree.search([a[0],a[1],a[0],a[1]]),o=!1;for(var l in r){var c=r[l][4];t(u.projection.invert(a),c)&&(i.events.click(e,c),o=!0)}o||i.events.click(e,null)}}}function h(){var t={scale:u.scale,translate:u.translate,width:u.width,height:u.height,map:u.map};for(var a in u.data){var e=u.data[a];e.events&&e.events.hover&&(e.hoverElement=!1,e.events.hover(t,null))}}function d(){var a=s(p.mouse(this),u.scale,u.translate),e={scale:u.scale,translate:u.translate,width:u.width,height:u.height,map:u.map};for(var n in u.data){var i=u.data[n];if(i.events&&i.events.hover&&(!i.hoverElement||!t(u.projection.invert(a),i.hoverElement))){i.hoverElement=!1;var r=i.lookupTree.search([a[0],a[1],a[0],a[1]]);for(var o in r){var l=r[o][4];if(t(u.projection.invert(a),l)){i.hoverElement=l;break}}i.events.hover(e,i.hoverElement)}}}var u=l({width:p.select(a.element).node().getBoundingClientRect().width,ratio:1,area:0,scale:1,translate:[0,0],background:null,backgroundScale:1,backgroundTranslate:[0,0],map:this},a),g=p.geo.transform({point:function(t,a,e){(!e||e>=u.area)&&this.stream.point(t,a)}}),v=null,f=null;if(!a.projection){var m=[[1/0,1/0],[-(1/0),-(1/0)]];for(var w in u.data)m=e(m,p.geo.bounds(u.data[w].features));u.projection=p.geo.mercator().scale(1).center([(m[1][0]+m[0][0])/2,(m[1][1]+m[0][1])/2])}var k=p.geo.path().projection({stream:function(t){return g.stream(u.projection.stream(t))}}),m=[[1/0,1/0],[-(1/0),-(1/0)]];for(var w in u.data)m=e(m,k.bounds(u.data[w].features));var b=m[1][0]-m[0][0],x=m[1][1]-m[0][1];a.projection?u.height||(u.height=Math.ceil(1*x/.9)):(u.height=u.height||Math.ceil(x*u.width/b),u.projection.scale(.9*(u.width/b)).translate([u.width/2,u.height/2])),p.select(u.parameters).attr("height",u.height),this.init=i,this.paint=o,this.settings=function(){return u}}function h(t){var a=new c(t);this.init=function(){a.init()},this.paint=function(){a.paint()}}function d(t,a){return Math.abs(t-a)<f}function u(t){var a=[],e=t;this.addImage=function(t){a.push(t)},this.getImage=function(t){for(var e in a){var n=a[e];if(d(n.scale,t.scale)&&d(n.translate[0],t.translate[0])&&d(n.translate[1],t.translate[1]))return n}return null},this.getFittingImage=function(t){var n=a.length>0?a[0]:null;for(var i in a){var r=a[i],o=[-r.translate[0],-r.translate[1],e.width/r.scale-r.translate[0],e.height/r.scale-r.translate[1]];o[0]<=t[0]&&o[1]<=t[1]&&o[2]>=t[2]&&o[3]>=t[3]&&(!n||n.scale<r.scale)&&(n=r)}return n}}function g(t){function a(t,a){if(!f){if(f=!0,d(t,h.scale)&&d(a[0],h.translate[0])&&d(a[1],h.translate[1])&&(t=1,a=[0,0]),!(1!=t||1!=h.scale||a[0]||a[1]||h.translate[0]||h.translate[1]))return void(f=!1);i=1/h.projection.scale()/t/h.ratio/20,l.save(),l.scale(t*h.ratio,t*h.ratio),l.translate(a[0],a[1]),l.clearRect(-a[0],-a[1],h.width*h.ratio,h.height*h.ratio);var n={path:g,context:l,scale:t,translate:a,width:h.width,height:h.height,map:h.map},c=v.getImage({scale:t,translate:a});if(!c)var u=new Image,m=new o(h.data,n);var w=s([h.width,h.height],t,a),k=s([h.width,h.height],h.scale,h.translate),b=[Math.min(-a[0],-h.translate[0]),Math.min(-a[1],-h.translate[1]),Math.max(w[0],k[0]),Math.max(w[1],k[1])],x=v.getFittingImage(b);x&&(h.background=x.image,h.backgroundScale=x.scale,h.backgroundTranslate=x.translate),p.transition().duration(300).ease("linear").tween("zoom",function(){var n=p.interpolateNumber(h.scale,t),i=h.translate,r=h.scale;return function(o){h.scale=n(o);var s=[i[0]+(a[0]-i[0])/(t-r)*(n(o)-r)*t/n(o),i[1]+(a[1]-i[1])/(t-r)*(n(o)-r)*t/n(o)];h.translate=s,e.paint(),!c&&m.renderNext()}}).each("end",function(){h.scale=t,h.translate=a,c?(l.restore(),h.background=c.image,h.backgroundScale=c.scale,h.backgroundTranslate=c.translate,e.paint()):(e.paint(),m.finish(),u.onload=function(){l.restore(),v.addImage({image:u,scale:t,translate:a}),h.background=u,h.backgroundScale=t,h.backgroundTranslate=a,e.paint()},u.src=r.node().toDataURL()),f=!1})}}var e=new c(t),n=p.geo.transform({point:function(t,a,e){e>=i&&this.stream.point(t,a)}}),i=0,r=null,l=null,h=e.settings(),g=p.geo.path().projection({stream:function(t){return n.stream(h.projection.stream(t))}}),v=new u({width:h.width,height:h.height}),f=!1;h.map=this,h.zoomScale=h.zoomScale||.5,this.init=function(){e.init(),r=p.select(h.element).append("canvas"),l=r.node().getContext("2d"),i=1/h.projection.scale()/h.ratio/20,r.attr("width",h.width*h.ratio),r.attr("height",h.height*h.ratio),r.style("width",h.width+"px"),r.style("height",h.height+"px"),r.style("display","none"),l.lineJoin="round",l.lineCap="round",g.context(l),v.addImage({image:h.background,scale:h.scale,translate:h.translate})},this.paint=function(){e.paint()},this.zoom=function(t){if(!t)return void a.call(this,1,[0,0]);var e=g.bounds(t),n=e[1][0]-e[0][0],i=e[1][1]-e[0][1],r=(e[0][0]+e[1][0])/2,o=(e[0][1]+e[1][1])/2,s=h.zoomScale*Math.min(h.width/n,h.height/i),l=[-r+h.width/s/2,-o+h.height/s/2];a.call(this,s,l)},this.settings=function(t){return e.settings()}}if("undefined"!=typeof module)var p=require("d3"),v=(require("topojson"),require("rbush"));else var p=window.d3,v=(window.topojson,window.rbush);var f=.5;"undefined"!=typeof module?module.exports={StaticCanvasMap:h,ZoomableCanvasMap:g}:(window.StaticCanvasMap=h,window.ZoomableCanvasMap=g)}();
